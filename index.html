using PdfSharp.Pdf;
using PdfSharp.Drawing;
using System;
using System.IO;
using System.Text.RegularExpressions;
using System.Collections.Generic;

class Program
{
    static void Main()
    {
        string inputPath = "ftsmprpt.rpt.SH1";
        string outputPath = "CashStatement.pdf";

        if (!File.Exists(inputPath))
        {
            Console.WriteLine("Input file not found.");
            return;
        }

        string[] lines = File.ReadAllLines(inputPath);
        GeneratePdf(lines, outputPath);
        Console.WriteLine("PDF generated: " + outputPath);
    }

    static void GeneratePdf(string[] lines, string outputPath)
    {
        PdfDocument doc = new PdfDocument();
        doc.Info.Title = "Cash Statement";
        PdfPage page = doc.AddPage();
        XGraphics gfx = XGraphics.FromPdfPage(page);
        XFont font = new XFont("Verdana", 9, XFontStyle.Regular);
        XFont boldFont = new XFont("Verdana", 9, XFontStyle.Bold);

        double y = 40;

        // Header
        gfx.DrawString("Consolidated Cash Statement", boldFont, XBrushes.Black, new XRect(0, y, page.Width, 20), XStringFormats.TopCenter);
        y += 25;

        foreach (string line in lines)
        {
            if (line.Contains("Client Basic"))
            {
                string client = Regex.Match(line, @"Client Basic\s+(\S+)").Groups[1].Value;
                gfx.DrawString("Client Basic: " + client, font, XBrushes.Black, 40, y);
                y += 15;
            }
            if (line.Contains("Statement Period"))
            {
                string period = Regex.Match(line, @"Statement Period\s+(\d{2}/\d{2}/\d{2}-\d{2}/\d{2}/\d{2})").Groups[1].Value;
                gfx.DrawString("Statement Period: " + period, font, XBrushes.Black, 40, y);
                y += 20;
            }
        }

        // Address and Company Info
        List<string> companyLines = new List<string>();
        foreach (string line in lines)
        {
            if (line.Contains("DICKSON") || line.Contains("OCEAN CENTRE") || line.Contains("HONG KONG"))
            {
                companyLines.Add(line.Trim());
            }
        }

        foreach (string line in companyLines)
        {
            gfx.DrawString(line, font, XBrushes.Black, 40, y);
            y += 15;
        }

        y += 15;
        gfx.DrawString("ACCOUNT SUMMARY", boldFont, XBrushes.Black, 40, y);
        y += 20;

        gfx.DrawString("Type", boldFont, XBrushes.Black, 40, y);
        gfx.DrawString("Account No", boldFont, XBrushes.Black, 120, y);
        gfx.DrawString("CCY", boldFont, XBrushes.Black, 240, y);
        gfx.DrawString("Balance", boldFont, XBrushes.Black, 280, y);
        gfx.DrawString("Exch Rate", boldFont, XBrushes.Black, 360, y);
        gfx.DrawString("HKD Equivalent", boldFont, XBrushes.Black, 430, y);
        y += 15;

        foreach (string line in lines)
        {
            if (line.Contains("CURRENT ACCOUNT") && line.Contains("HK"))
            {
                var match = Regex.Match(line, @"(\d[\d\s]+)\s+HK\s+([\d,]+\.\d{2})\s+([\d\.]+)\s+([\d,]+\.\d{2})");
                if (match.Success)
                {
                    string accNum = match.Groups[1].Value.Trim();
                    string balance = match.Groups[2].Value;
                    string rate = match.Groups[3].Value;
                    string hkdEq = match.Groups[4].Value;

                    gfx.DrawString("Current", font, XBrushes.Black, 40, y);
                    gfx.DrawString(accNum, font, XBrushes.Black, 120, y);
                    gfx.DrawString("HK", font, XBrushes.Black, 240, y);
                    gfx.DrawString(balance, font, XBrushes.Black, 280, y);
                    gfx.DrawString(rate, font, XBrushes.Black, 360, y);
                    gfx.DrawString(hkdEq, font, XBrushes.Black, 430, y);
                    y += 15;
                }
            }
        }

        y += 20;
        gfx.DrawString("ACCOUNT ACTIVITIES", boldFont, XBrushes.Black, 40, y);
        y += 20;

        gfx.DrawString("Date", boldFont, XBrushes.Black, 40, y);
        gfx.DrawString("Transaction", boldFont, XBrushes.Black, 100, y);
        gfx.DrawString("Deposit", boldFont, XBrushes.Black, 250, y);
        gfx.DrawString("Withdrawal", boldFont, XBrushes.Black, 320, y);
        gfx.DrawString("Balance", boldFont, XBrushes.Black, 400, y);
        y += 15;

        foreach (string line in lines)
        {
            if (Regex.IsMatch(line, @"\d{2} OCT"))
            {
                var parts = Regex.Split(line.Trim(), @"\s{2,}");
                if (parts.Length >= 4)
                {
                    string date = parts[0];
                    string transaction = parts[1];
                    string deposit = parts[2];
                    string withdrawal = parts[3];
                    string balance = parts.Length > 4 ? parts[4] : "";

                    gfx.DrawString(date, font, XBrushes.Black, 40, y);
                    gfx.DrawString(transaction, font, XBrushes.Black, 100, y);
                    gfx.DrawString(deposit, font, XBrushes.Black, 250, y);
                    gfx.DrawString(withdrawal, font, XBrushes.Black, 320, y);
                    gfx.DrawString(balance, font, XBrushes.Black, 400, y);
                    y += 15;
                }
            }
        }

        doc.Save(outputPath);
    }
}
