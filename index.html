using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using iTextSharp.text;
using iTextSharp.text.pdf;

namespace BankStatementGenerator
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Enter path to rpt.SH1 file:");
            string inputPath = Console.ReadLine();
            
            Console.WriteLine("Enter output PDF path:");
            string outputPath = Console.ReadLine();

            if (File.Exists(inputPath))
            {
                try
                {
                    var statementData = ParseRptFile(inputPath);
                    GeneratePdf(statementData, outputPath);
                    Console.WriteLine($"PDF generated successfully at {outputPath}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error: {ex.Message}");
                }
            }
            else
            {
                Console.WriteLine("Input file not found");
            }
        }

        static StatementData ParseRptFile(string filePath)
        {
            var data = new StatementData();
            var lines = File.ReadAllLines(filePath).ToList();

            // Find start of relevant data
            int startIndex = lines.FindIndex(line => line.Contains("Consolidated Cash Statement"));
            if (startIndex == -1) throw new Exception("File format not recognized");
            
            // Extract client information
            data.ClientBasic = CleanValue(ExtractValue(lines, "Client Basic", startIndex, 20));
            data.StatementPeriod = CleanValue(ExtractValue(lines, "Statement Period", startIndex, 20));
            
            // Extract company name and address
            int nameIndex = lines.FindIndex(startIndex, line => line.Contains("DICKSON CONCEPTS"));
            if (nameIndex != -1)
            {
                data.CompanyName = "DICKSON CONCEPTS (WHOLESALE) LIMITED";
                
                // Extract address lines and clean them
                var addressLines = lines
                    .Skip(nameIndex + 1)
                    .TakeWhile(line => !line.Contains("Account Number") && 
                                       !line.Contains("ACCOUNT SUMMARY") &&
                                       !string.IsNullOrWhiteSpace(line))
                    .Select(CleanValue)
                    .Where(line => !Regex.IsMatch(line, @"^\d+$")) // Exlines with only digits
                    .ToList();
                
                data.Address = string.Join("\n", addressLines);
            }

            // Extract account summary
            int accountIndex = lines.FindIndex(startIndex, line => line.Contains("Account Number"));
            if (accountIndex != -1)
            {
                // Find the next line with numeric data
                var accountLine = lines
                    .Skip(accountIndex + 1)
                    .FirstOrDefault(line => Regex.IsMatch(line, @"\d"));
                
                if (!string.IsNullOrEmpty(accountLine))
                {
                    accountLine = CleanValue(accountLine);
                    var accountParts = accountLine.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                    if (accountParts.Length >= 3)
                    {
                        data.AccountNumber = accountParts[0];
                        data.Currency = "HKD";
                        if (decimal.TryParse(accountParts[2], NumberStyles.Currency, 
                            CultureInfo.InvariantCulture, out decimal balance))
                        {
                            data.OpeningBalance = balance;
                            data.ClosingBalance = balance; // Default to opening balance
                        }
                    }
                }
            }

            // Extract account activities
            int activitiesIndex = lines.FindIndex(startIndex, line => 
                line.Contains("ACCOUNT ACTIVITIES") || line.Contains("CURRENT ACCOUNT"));
            
            if (activitiesIndex != -1)
            {
                // Find the transaction table start
                int tableStart = lines.FindIndex(activitiesIndex, line => 
                    Regex.IsMatch(line, @"\d{2}\s[A-Z]{3}"));
                
                if (tableStart != -1)
                {
                    // Process transaction lines
                    foreach (var line in lines.Skip(tableStart))
                    {
                        if (string.IsNullOrWhiteSpace(line)) break;
                        if (line.Contains("Page")) continue;
                        
                        // Clean the line before processing
                        string cleanLine = CleanValue(line);
                        
                        // Match date pattern (e.g., "01 OCT")
                        var dateMatch = Regex.Match(cleanLine, @"(\d{2}\s[A-Z]{3})");
                        if (!dateMatch.Success) continue;
                        
                        string date = dateMatch.Value;
                        string description = ExtractDescription(cleanLine, dateMatch.Index + dateMatch.Length);
                        decimal balance = ExtractBalance(cleanLine);

                        if (balance != 0)
                        {
                            data.Activities.Add(new AccountActivity
                            {
                                Date = date,
                                Description = description,
                                Balance = balance
                            });
                        }
                        
                        // Check for closing balance
                        if (cleanLine.Contains("Closing Balance"))
                        {
                            data.ClosingBalance = balance;
                        }
                    }
                }
            }

            return data;
        }

        static string ExtractValue(List<string> lines, string key, int startIndex, int range)
        {
            var line = lines
                .Skip(startIndex)
                .Take(range)
                .FirstOrDefault(l => l.Contains(key));
            
            return line != null ? line.Substring(line.IndexOf(key) + key.Length).Trim() : "";
        }

        static string CleanValue(string input)
        {
            // Remove trailing numbers like "21" at end of lines
            string cleaned = Regex.Replace(input, @"\s*\d+\s*$", "");
            // Remove any standalone long digit strings
            cleaned = Regex.Replace(cleaned, @"\b\d{12,}\b", "");
            return cleaned.Trim();
        }

        static string ExtractDescription(string line, int startIndex)
        {
            // Find the next numeric value after the description
            var match = Regex.Match(line.Substring(startIndex), @"(.+?)(\d[\d,.]*\d|\d)");
            return match.Success ? match.Groups[1].Value.Trim() : line.Substring(startIndex).Trim();
        }

        static decimal ExtractBalance(string line)
        {
            // Find the last numeric value in the line
            var matches = Regex.Matches(line, @"([\d,]+\.\d{2})");
            return matches.Count > 0 ? 
                decimal.Parse(matches[^1].Value, NumberStyles.Currency, CultureInfo.InvariantCulture) : 0;
        }

        static void GeneratePdf(StatementData data, string outputPath)
        {
            using (var fs = new FileStream(outputPath, FileMode.Create))
            {
                var doc = new Document(PageSize.A4, 25, 25, 30, 30);
                var writer = PdfWriter.GetInstance(doc, fs);
                doc.Open();

                // Base font setup
                var baseFont = BaseFont.CreateFont(
                    BaseFont.HELVETICA, 
                    BaseFont.CP1252, 
                    BaseFont.NOT_EMBEDDED
                );

                // Title
                var titleFont = new Font(baseFont, 16, Font.BOLD);
                doc.Add(new Paragraph("Consolidated Cash Statement", titleFont) 
                { 
                    Alignment = Element.ALIGN_CENTER,
                    SpacingAfter = 10
                });

                // Client Information
                var infoFont = new Font(baseFont, 9);
                doc.Add(new Paragraph($"Client Basic: {data.ClientBasic}", infoFont));
                doc.Add(new Paragraph($"Statement Period: {data.StatementPeriod}", infoFont));
                doc.Add(new Paragraph(data.CompanyName, infoFont));
                doc.Add(new Paragraph(data.Address, infoFont));
                doc.Add(Chunk.NEWLINE);

                // Account Summary Table
                var summaryTable = new PdfPTable(6);
                summaryTable.WidthPercentage = 100;
                summaryTable.SetWidths(new float[] { 2, 3, 1, 2, 2, 2 });

                // Table headers
                var headerFont = new Font(baseFont, 9, Font.BOLD);
                AddTableHeader(summaryTable, "Account Type", headerFont);
                AddTableHeader(summaryTable, "Account Number", headerFont);
                AddTableHeader(summaryTable, "CCY ID", headerFont);
                AddTableHeader(summaryTable, "Balance", headerFont);
                AddTableHeader(summaryTable, "Exch Rate as at 31/10", headerFont);
                AddTableHeader(summaryTable, "HKD Equivalent", headerFont);

                // Table data
                var dataFont = new Font(baseFont, 9);
                AddTableCell(summaryTable, "Current", dataFont);
                AddTableCell(summaryTable, data.AccountNumber, dataFont);
                AddTableCell(summaryTable, "HKD", dataFont);
                AddTableCell(summaryTable, data.OpeningBalance.ToString("N2"), dataFont, Element.ALIGN_RIGHT);
                AddTableCell(summaryTable, "1.0000000", dataFont, Element.ALIGN_RIGHT);
                AddTableCell(summaryTable, data.OpeningBalance.ToString("N2"), dataFont, Element.ALIGN_RIGHT);

                doc.Add(summaryTable);
                doc.Add(Chunk.NEWLINE);

                // Account Activities
                var sectionFont = new Font(baseFont, 10, Font.BOLD);
                doc.Add(new Paragraph($"CURRENT ACCOUNT   {data.AccountNumber}   HKD", sectionFont));
                doc.Add(Chunk.NEWLINE);

                var activityTable = new PdfPTable(5);
                activityTable.WidthPercentage = 100;
                activityTable.SetWidths(new float[] { 1.5f, 5f, 2f, 2f, 2f });

                // Table headers
                AddTableHeader(activityTable, "Date", headerFont);
                AddTableHeader(activityTable, "Transaction Details", headerFont);
                AddTableHeader(activityTable, "Deposit", headerFont);
                AddTableHeader(activityTable, "Withdrawal", headerFont);
                AddTableHeader(activityTable, "Balance", headerFont);

                // Add activities
                foreach (var activity in data.Activities)
                {
                    AddTableCell(activityTable, activity.Date, dataFont);
                    AddTableCell(activityTable, activity.Description, dataFont);
                    AddTableCell(activityTable, "0.00", dataFont, Element.ALIGN_RIGHT);
                    AddTableCell(activityTable, "0.00", dataFont, Element.ALIGN_RIGHT);
                    AddTableCell(activityTable, activity.Balance.ToString("N2"), dataFont, Element.ALIGN_RIGHT);
                }

                // Add "Total Credit-Debit Amounts" row
                AddTableCell(activityTable, "", dataFont);
                AddTableCell(activityTable, "Total Credit-Debit Amounts", headerFont);
                AddTableCell(activityTable, "0.00", dataFont, Element.ALIGN_RIGHT);
                AddTableCell(activityTable, "0.00", dataFont, Element.ALIGN_RIGHT);
                AddTableCell(activityTable, data.ClosingBalance.ToString("N2"), dataFont, Element.ALIGN_RIGHT);

                doc.Add(activityTable);
                doc.Add(Chunk.NEWLINE);
                doc.Add(Chunk.NEWLINE);

                // Important Notice
                var noticeFont = new Font(baseFont, 9, Font.BOLD);
                doc.Add(new Paragraph("IMPORTANT", noticeFont));
                
                var normalFont = new Font(baseFont, 9);
                doc.Add(new Paragraph("THIS STATEMENT WILL BE CONSIDERED CORRECT IF NO ERROR OR OMISSION " +
                    "IS REPORTED TO THE BANK WITHIN 90 DAYS OF STATEMENT POSTING DATE.", normalFont));
                doc.Add(new Paragraph("For complaints, please call our Client Services section " +
                    "at 2108 5449 or email us at csd_herojemo@eec.sorgevans.com.", normalFont));

                // Add page footer
                var footer = new Paragraph("PAGE    1 OF    1", new Font(baseFont, 9))
                {
                    Alignment = Element.ALIGN_CENTER
                };
                doc.Add(footer);

                doc.Close();
            }
        }

        static void AddTableHeader(PdfPTable table, string text, Font font)
        {
            var cell = new PdfPCell(new Phrase(text, font))
            {
                BackgroundColor = new BaseColor(220, 220, 220),
                HorizontalAlignment = Element.ALIGN_CENTER,
                Padding = 5,
                PaddingTop = 3,
                PaddingBottom = 3
            };
            table.AddCell(cell);
        }

        static void AddTableCell(PdfPTable table, string text, Font font, int alignment = Element.ALIGN_LEFT)
        {
            var cell = new PdfPCell(new Phrase(text, font))
            {
                Padding = 5,
                PaddingTop = 3,
                PaddingBottom = 3,
                HorizontalAlignment = alignment
            };
            table.AddCell(cell);
        }
    }

    // Data Classes
    public class StatementData
    {
        public string ClientBasic { get; set; } = "00001-000068";
        public string StatementPeriod { get; set; } = "01/10/24-31/10/24";
        public string CompanyName { get; set; } = "DICKSON CONCEPTS (WHOLESALE) LIMITED";
        public string Address { get; set; } = "OCEAN CENTRE\n98 GRANVILLE ROAD\nTSIM SHA TSUI HONG KONG";
        public string AccountNumber { get; set; } = "001-0000-001-0";
        public string Currency { get; set; } = "HKD";
        public decimal OpeningBalance { get; set; } = 46972.84M;
        public decimal ClosingBalance { get; set; } = 46972.84M;
        public List<AccountActivity> Activities { get; set; } = new List<AccountActivity>();
    }

    public class AccountActivity
    {
        public string Date { get; set; }
        public string Description { get; set; }
        public decimal Balance { get; set; }
    }
}
